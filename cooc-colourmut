#!/usr/bin/env python3
import os
import argparse
import json
import yaml


# parse command line
argparser = argparse.ArgumentParser(description="print coloured pretty table on terminal",
	epilog="see cooc-pubmut for a CSV file that can be imported into an article")
argparser.add_argument('-a', '--amplicons', metavar='YAML', required=True,
	type=str, dest='amp', help="list of query amplicons, from mutbamscan")
inputgroup = argparser.add_mutually_exclusive_group(required=True)
inputgroup.add_argument('-j', '--json', metavar='JSON',
	type=str, dest='json', help="results generated by mutbamscan")
inputgroup.add_argument('-y', '--yaml', metavar='YAML',
	type=str, dest='yaml', help="results generated by mutbamscan")
args = argparser.parse_args()


# load table
table={}

if args.json:
	assert os.path.isfile(args.json), f"cannot find result json file {args.json}"
	with open(args.json, 'rt') as jf:
		table=json.load(fp=jf)
elif args.yaml:
	assert os.path.isfile(args.yaml), f"cannot find result yaml file {args.yaml}"
	with open(args.yaml, 'rt') as yf:
		table=yaml.safe_load(yf)

assert len(table) > 0, "cannot succesfully load table"

# reuse stored amplicons
amplicon_nfo={ }

assert os.path.isfile(args.amp), f"cannot find amplicon file yaml file {args.amp}"
with open(args.amp, 'rt') as yf:
	amp_str = yaml.safe_load(yf)

amplicon_nfo = {
		a: ','.join([
				f"{p}{b}" if len(b) == 1 else (f"\u0394{p}-{p + len(b) - 1}" if  b == '-' * len(b) else f"{p}\u2192{b}")for p,b in aqu[4].items()
			]) for a,aqu in amp_str.items()
	}



#
# pretty print
#

l=max(len(k) for k in table)
print(f"{'':<{l}} ", end='')
for a in amplicon_nfo: print(f" {a :<26}", end='')
print(f"\n{'':<{l}}  ", end='')
for a,label in amplicon_nfo.items(): print(f"{label if len(label)<=27 else (label[:26]+chr(0x2026)) :<27.27}", end='')
print(f"\n{'sample:':<{l}} ", end='')
for a in amplicon_nfo: print(f"{'cov:' :>9}{'mut:' :>9}{'frq/%:' :>9}", end='')
print()

for sam,amplicons in table.items():
	print(f"{sam :>{l}} ", end='')

	for ampname in amplicon_nfo: # instead of `ampname,amp in amplicons.items():`, to keep order consistent with column titles.
		amp = amplicons[ampname]
        
		# get topmost
		sites_cnt_l=-1
		sites_cnt=0
		if amp['sites']: # empty ?
			(sites_cnt_l,sites_cnt)=list(amp['sites'].items())[-1]
		muts_cnt_l=-1
		muts_cnt=0
		if amp['muts']: # empty ?
			(muts_cnt_l,muts_cnt)=list(amp['muts'].items())[-1]

		# pretty print
		if sites_cnt:
			print(f"{sites_cnt :>9}",end='')
			if muts_cnt:
				if muts_cnt_l != sites_cnt_l:
					print(f"\x1b[33;1m{muts_cnt :>9}{f'({muts_cnt_l}/{sites_cnt_l})' :>9}\x1b[0m",end='')
				else:
					print(f"\x1b[32;1m{muts_cnt :>9}{100*muts_cnt/sites_cnt :7.2f}%{sites_cnt_l}\x1b[0m",end='')
			else:
				print(f"\x1b[31;1m{'N/A' :>9}{'N/A' :>9}\x1b[0m", end='')
		else:
			print(f"\x1b[35;1m{'N/A' :>9}{'N/A' :>9}{'N/A' :>9}\x1b[0m", end='')

	print()


